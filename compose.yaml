version: "3.0"
name: example_workcell
services:
  wei_server:
    image: wei
    container_name: wei_server
    ports:
      - 8000:8000
    volumes:
      - ./workcell_defs:/workcell_defs
      - ~/.wei:/root/.wei
    command: pdm run server --workcell /workcell_defs/example_workcell.yaml --redis_host redis --port 8000
    depends_on:
      - redis
  wei_engine:
    image: wei
    container_name: wei_engine
    volumes:
      - ./workcell_defs:/workcell_defs
      - ~/.wei:/root/.wei
    command: pdm run engine --workcell /workcell_defs/example_workcell.yaml --redis_host redis --server wei_server
    depends_on:
      - redis
      - wei_server
      - sleep_node
      - webcam_node
  redis:
    image: redis
    container_name: redis
    ports:
      - 6379:6379
    volumes:
      - ~/.wei/redis_data:/data
    command: redis-server --save 60 1 --loglevel warning
  sleep_node:
    image: sleep_module
    container_name: sleep_node
    command: python /sleep_module/src/sleep_rest_node.py
    ports:
      - 2000:2000
  webcam_node:
    image: webcam_module
    container_name: webcam_node
    privileged: true # needed for hardware access
    volumes:
      - /dev/video0:/dev/video0
    ports:
      - 2001:2000
    command: python /webcam_module/src/webcam_rest_node.py
  example_app:
    image: example_app
    build:
      context: .
      dockerfile: ./Dockerfile
    volumes:
      - ./example_app:/example_app
    command: python /example_app/example_app.py
    depends_on:
      - wei_engine
      - wei_server
      - sleep_node
      - webcam_node
